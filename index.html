<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0a0a0a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ghosting">
<title>Ghosting — Squash Court Trainer</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow-x: hidden; }
  body {
    background: #0a0a0a; color: #f0f0f0;
    font-family: 'Oswald', 'Impact', 'Arial Black', sans-serif;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }
  .grain {
    position: fixed; inset: 0; opacity: 0.04; z-index: 0; pointer-events: none;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  }
  .flash-overlay {
    position: fixed; inset: 0; z-index: 10; pointer-events: none;
    background: transparent; transition: background 0.1s ease-out;
  }
  .flash-overlay.active { background: rgba(255, 60, 0, 0.15); }
  .container {
    position: relative; z-index: 1; width: 100%; max-width: 420px;
    margin: 0 auto; padding: 20px 16px; min-height: 100vh;
  }
  h1 {
    font-family: 'Bebas Neue', 'Oswald', sans-serif;
    font-size: 42px; letter-spacing: 6px; line-height: 1; text-align: center;
    background: linear-gradient(180deg, #FF4400 0%, #FF6B35 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .subtitle {
    font-size: 11px; letter-spacing: 8px; color: #666;
    text-transform: uppercase; text-align: center; margin-top: 4px;
  }
  .section-label {
    font-size: 9px; letter-spacing: 3px; color: #333;
    text-transform: uppercase; margin-bottom: 10px;
  }
  .btn-settings {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    width: 100%; padding: 10px 0; background: transparent; border: 1px solid #222;
    border-radius: 8px; cursor: pointer; color: #666;
    font-family: 'Oswald', sans-serif; font-size: 13px;
    letter-spacing: 3px; text-transform: uppercase; margin-bottom: 16px;
  }
  .settings-panel {
    background: #111; border: 1px solid #222; border-radius: 12px;
    padding: 20px; margin-bottom: 20px;
    animation: slideDown 0.2s ease-out;
  }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  input[type=range] {
    -webkit-appearance: none; width: 100%; height: 4px;
    background: #222; border-radius: 2px; outline: none;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 20px; height: 20px;
    background: #FF4400; border-radius: 50%; cursor: pointer; border: 2px solid #FF6B35;
  }
  .pos-toggle { display: flex; gap: 8px; }
  .pos-toggle button {
    flex: 1; padding: 12px 8px; border-radius: 10px; cursor: pointer;
    font-family: 'Oswald', sans-serif; text-align: center; transition: all 0.2s;
  }
  .pos-toggle button.active {
    background: rgba(255,68,0,0.15); border: 1px solid rgba(255,68,0,0.4); color: #FF4400;
  }
  .pos-toggle button.inactive {
    background: #0a0a0a; border: 1px solid #222; color: #555;
  }
  .pos-toggle .num { font-family: 'Bebas Neue', sans-serif; font-size: 32px; line-height: 1; }
  .pos-toggle .lbl { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; margin-top: 4px; }
  .pos-toggle button.active .lbl { color: #FF6B35; }
  .pos-toggle button.inactive .lbl { color: #444; }
  .presets { display: flex; gap: 8px; margin-top: 16px; }
  .presets button {
    flex: 1; padding: 8px 4px; border-radius: 8px; cursor: pointer;
    font-family: 'Oswald', sans-serif; font-size: 10px; letter-spacing: 1px;
    text-transform: uppercase; transition: all 0.2s;
  }
  .presets button.active { background: rgba(255,68,0,0.15); border: 1px solid rgba(255,68,0,0.4); color: #FF4400; }
  .presets button.inactive { background: #0a0a0a; border: 1px solid #222; color: #555; }
  .number-display {
    border-radius: 20px; padding: 28px 0; text-align: center;
    margin-bottom: 16px; transition: all 0.3s;
  }
  .number-display.running { background: radial-gradient(circle at center, rgba(255,68,0,0.08) 0%, transparent 70%); }
  .big-number {
    font-family: 'Bebas Neue', 'Oswald', sans-serif; font-weight: 700; line-height: 1;
    transition: all 0.2s ease-out;
  }
  .big-number.active { font-size: 180px; color: #FF4400; text-shadow: 0 0 60px rgba(255,68,0,0.4), 0 0 120px rgba(255,68,0,0.15); }
  .big-number.inactive { font-size: 80px; color: #222; }
  .big-number.flash { transform: scale(1.08); }
  .pos-label {
    font-size: 18px; letter-spacing: 4px; color: #FF6B35;
    text-transform: uppercase; margin-top: 8px; transition: opacity 0.3s;
  }
  .court-box {
    background: #111; border: 1px solid #222; border-radius: 12px;
    padding: 16px; margin-bottom: 20px;
  }
  .btn-main {
    width: 100%; padding: 18px 0; border-radius: 12px; cursor: pointer;
    font-family: 'Bebas Neue', 'Oswald', sans-serif;
    font-size: 22px; letter-spacing: 6px; text-transform: uppercase; transition: all 0.2s;
  }
  .btn-main.start {
    background: linear-gradient(180deg, #FF4400 0%, #CC3600 100%);
    color: #fff; border: 1px solid #FF6B35;
    box-shadow: 0 4px 30px rgba(255,68,0,0.3);
  }
  .btn-main.stop {
    background: linear-gradient(180deg, #1a1a1a 0%, #111 100%);
    color: #777; border: 1px solid #333; box-shadow: none;
  }
  .summary-row {
    display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;
    margin-bottom: 12px; font-size: 12px; color: #444;
  }
  .summary-row .val { color: #FF4400; font-family: 'Bebas Neue', sans-serif; font-size: 16px; }
  .timer-row {
    display: flex; justify-content: space-between;
    font-size: 11px; letter-spacing: 3px; color: #555;
    text-transform: uppercase; margin-bottom: 6px;
  }
  .bar { height: 3px; background: #1a1a1a; border-radius: 2px; overflow: hidden; }
  .bar.session { height: 6px; border-radius: 3px; margin-bottom: 16px; }
  .bar-fill { height: 100%; border-radius: inherit; transition: width 1s linear, background 0.3s; }
  .history-grid { display: flex; flex-wrap: wrap; gap: 6px; }
  .history-item {
    width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
    border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: 700;
  }
  .position-key {
    margin-top: 28px; padding-top: 16px; border-top: 1px solid #1a1a1a;
    display: grid; grid-template-columns: 1fr 1fr; gap: 6px 20px;
  }
  .position-key .pk-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; }
  .position-key .pk-num {
    color: #FF4400; font-weight: 700; font-family: 'Bebas Neue', sans-serif;
    font-size: 16px; width: 16px; text-align: center;
  }
  .session-done {
    background: #111; border: 1px solid #222; border-radius: 16px;
    padding: 32px; margin-bottom: 24px; text-align: center;
    animation: slideDown 0.3s ease-out;
  }
  .session-done h2 {
    font-family: 'Bebas Neue', sans-serif; font-size: 48px; color: #FF4400;
    letter-spacing: 4px; line-height: 1; margin-bottom: 8px;
    background: none; -webkit-text-fill-color: #FF4400;
  }
  .session-done .btn-new {
    padding: 14px 40px; background: linear-gradient(180deg, #FF4400 0%, #CC3600 100%);
    color: #fff; border: 1px solid #FF6B35; border-radius: 10px; cursor: pointer;
    font-family: 'Bebas Neue', 'Oswald', sans-serif; font-size: 20px; letter-spacing: 4px;
    box-shadow: 0 4px 30px rgba(255,68,0,0.3);
  }
  .hidden { display: none !important; }
  .slider-label {
    display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px;
  }
  .slider-label label { font-size: 11px; letter-spacing: 3px; color: #555; text-transform: uppercase; }
  .slider-label .slider-val { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: #FF4400; line-height: 1; }
  .slider-label .slider-unit { font-size: 14px; color: #666; margin-left: 2px; }
  .slider-range { display: flex; justify-content: space-between; font-size: 10px; color: #333; margin-top: 4px; }
</style>
</head>
<body>

<div class="grain"></div>
<div class="flash-overlay" id="flashOverlay"></div>

<div class="container">
  <div style="text-align:center;margin-bottom:20px">
    <h1>GHOSTING</h1>
    <p class="subtitle">Squash Court Trainer</p>
  </div>

  <!-- Settings Toggle -->
  <button class="btn-settings" id="btnToggleSettings" onclick="toggleSettings()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
    </svg>
    <span id="settingsLabel">Settings</span>
  </button>

  <!-- Settings Panel -->
  <div class="settings-panel hidden" id="settingsPanel">
    <div class="section-label">Court Positions</div>
    <div class="pos-toggle" style="margin-bottom:24px">
      <button id="pos6btn" onclick="setPositions(6)"><div class="num">6</div><div class="lbl">Standard</div></button>
      <button id="pos8btn" onclick="setPositions(8)"><div class="num">8</div><div class="lbl">+ Serve Boxes</div></button>
    </div>

    <div style="margin-bottom:24px">
      <div class="slider-label">
        <label>Interval</label>
        <span><span class="slider-val" id="intervalVal"></span><span class="slider-unit">sec</span></span>
      </div>
      <input type="range" id="intervalSlider" min="3" max="60" value="15" oninput="updateInterval(this.value)">
      <div class="slider-range"><span>3s</span><span>60s</span></div>
    </div>

    <div>
      <div class="slider-label">
        <label>Total Time</label>
        <span class="slider-val" id="totalVal"></span>
      </div>
      <input type="range" id="totalSlider" min="30" max="1800" step="30" value="300" oninput="updateTotal(this.value)">
      <div class="slider-range"><span>0:30</span><span>30:00</span></div>
    </div>

    <div class="section-label" style="margin-top:16px">Presets</div>
    <div class="presets">
      <button onclick="applyPreset(10,120)">Quick</button>
      <button onclick="applyPreset(15,300)">Standard</button>
      <button onclick="applyPreset(8,600)">Intense</button>
      <button onclick="applyPreset(12,900)">Endurance</button>
    </div>
  </div>

  <!-- Session Done -->
  <div class="session-done hidden" id="sessionDone">
    <h2>SESSION COMPLETE</h2>
    <div style="color:#555;font-size:14px;margin-bottom:4px" id="doneStats"></div>
    <div style="color:#333;font-size:12px;margin-bottom:24px" id="doneDetail"></div>
    <button class="btn-new" onclick="resetSession()">NEW SESSION</button>
  </div>

  <!-- Number Display -->
  <div class="number-display" id="numberDisplay">
    <div class="big-number inactive" id="bigNumber">—</div>
    <div class="pos-label hidden" id="posLabel"></div>
  </div>

  <!-- Timers -->
  <div class="hidden" id="timersSection">
    <div class="timer-row">
      <span>Session</span>
      <span id="sessionTime" style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:#888"></span>
    </div>
    <div class="bar session"><div class="bar-fill" id="sessionBar" style="width:0;background:linear-gradient(90deg,#FF4400,#CC3600)"></div></div>
    <div class="timer-row">
      <span>Next position</span>
      <span id="nextTime" style="font-weight:700;color:#777"></span>
    </div>
    <div class="bar"><div class="bar-fill" id="nextBar" style="width:0;background:linear-gradient(90deg,#333,#555)"></div></div>
  </div>

  <!-- Court -->
  <div class="court-box" id="courtBox">
    <div class="section-label" style="text-align:center" id="courtLabel">Court Map · 6 Positions</div>
    <svg id="courtSvg" viewBox="0 0 100 130" style="width:100%;height:auto"></svg>
  </div>

  <!-- Summary + Start/Stop -->
  <div class="summary-row" id="summaryRow">
    <span><span class="val" id="sumInterval"></span> interval</span>
    <span><span class="val" id="sumTotal"></span> total</span>
    <span><span class="val" id="sumPos"></span> positions</span>
  </div>
  <button class="btn-main start" id="btnMain" onclick="toggleRun()">START GHOSTING</button>

  <!-- History -->
  <div class="hidden" id="historySection" style="margin-top:24px">
    <div class="section-label" id="historyLabel">History</div>
    <div class="history-grid" id="historyGrid"></div>
  </div>

  <!-- Position Key -->
  <div style="margin-top:28px;padding-top:16px;border-top:1px solid #1a1a1a">
    <div class="section-label" style="margin-bottom:12px">Positions</div>
    <div class="position-key" id="positionKey"></div>
  </div>
</div>

<script>
const POSITIONS_6 = {
  1:{label:"Front Left",x:22,y:22},2:{label:"Front Right",x:78,y:22},
  3:{label:"Mid Left",x:22,y:58},4:{label:"Mid Right",x:78,y:58},
  5:{label:"Back Left",x:22,y:108},6:{label:"Back Right",x:78,y:108}
};
const POSITIONS_8 = {
  1:{label:"Front Left",x:22,y:22},2:{label:"Front Right",x:78,y:22},
  3:{label:"Mid Left",x:22,y:58},4:{label:"Mid Right",x:78,y:58},
  5:{label:"Serve Left",x:22,y:82,isServe:true},6:{label:"Serve Right",x:78,y:82,isServe:true},
  7:{label:"Back Left",x:22,y:108},8:{label:"Back Right",x:78,y:108}
};

let state = {
  running: false, done: false, showSettings: false,
  interval: 15, totalTime: 300, positions: 6,
  current: null, countdown: 0, totalRemaining: 0,
  history: [], flash: false
};
let intId, cdId, totId, audioCtx;

function getPositions() { return state.positions === 8 ? POSITIONS_8 : POSITIONS_6; }
function fmt(s) { return Math.floor(s/60)+':'+String(s%60).padStart(2,'0'); }

function loadSettings() {
  try {
    const s = localStorage.getItem('ghosting-settings');
    if (s) {
      const p = JSON.parse(s);
      if (p.interval) state.interval = p.interval;
      if (p.totalTime) state.totalTime = p.totalTime;
      if (p.positions) state.positions = p.positions;
    }
  } catch(e) {}
}
function saveSettings() {
  try { localStorage.setItem('ghosting-settings', JSON.stringify({interval:state.interval,totalTime:state.totalTime,positions:state.positions})); } catch(e) {}
}

function playBeep(finish) {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if (finish) {
      [0,0.2,0.4].forEach(d => {
        const o=audioCtx.createOscillator(),g=audioCtx.createGain();
        o.connect(g);g.connect(audioCtx.destination);o.type='square';
        o.frequency.setValueAtTime(d===0.4?1200:880,audioCtx.currentTime+d);
        g.gain.setValueAtTime(0.3,audioCtx.currentTime+d);
        g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+d+0.15);
        o.start(audioCtx.currentTime+d);o.stop(audioCtx.currentTime+d+0.15);
      });
    } else {
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.connect(g);g.connect(audioCtx.destination);o.type='square';
      o.frequency.setValueAtTime(880,audioCtx.currentTime);
      g.gain.setValueAtTime(0.3,audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.15);
      o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.15);
    }
  } catch(e) {}
}

function generate() {
  state.current = Math.floor(Math.random()*state.positions)+1;
  state.history.unshift(state.current);
  if (state.history.length>30) state.history.pop();
  state.flash = true;
  playBeep(false);
  render();
  setTimeout(() => { state.flash=false; render(); }, 400);
}

function startSession() {
  state.running=true; state.done=false; state.history=[];
  state.countdown=state.interval; state.totalRemaining=state.totalTime;
  generate();
  intId=setInterval(()=>{ state.countdown=state.interval; generate(); }, state.interval*1000);
  cdId=setInterval(()=>{ state.countdown=Math.max(0,state.countdown-1); render(); },1000);
  totId=setInterval(()=>{ state.totalRemaining--; if(state.totalRemaining<=0) stopSession(true); render(); },1000);
  render();
}
function stopSession(finished) {
  state.running=false;
  clearInterval(intId);clearInterval(cdId);clearInterval(totId);
  if (finished) { state.done=true; playBeep(true); }
  else { state.current=null; state.countdown=0; state.totalRemaining=0; }
  render();
}
function resetSession() {
  state.done=false; state.current=null; state.history=[]; state.countdown=0; state.totalRemaining=0;
  render();
}
function toggleRun() { state.running ? stopSession(false) : startSession(); }
function toggleSettings() { state.showSettings=!state.showSettings; render(); }

function setPositions(n) { state.positions=n; saveSettings(); render(); }
function updateInterval(v) { state.interval=parseInt(v); saveSettings(); render(); }
function updateTotal(v) { state.totalTime=parseInt(v); saveSettings(); render(); }
function applyPreset(i,t) { state.interval=i; state.totalTime=t; saveSettings(); render(); }

function drawCourt() {
  const svg = document.getElementById('courtSvg');
  const pos = getPositions();
  let h = '';
  // Court outline
  h += '<rect x="10" y="5" width="80" height="120" fill="none" stroke="#222" stroke-width="0.8"/>';
  // Front wall
  h += '<line x1="10" y1="5" x2="90" y2="5" stroke="#444" stroke-width="1.5"/>';
  // Tin
  h += '<line x1="10" y1="8" x2="90" y2="8" stroke="#1a1a1a" stroke-width="0.4" stroke-dasharray="2 2"/>';
  // Short line
  h += '<line x1="10" y1="62" x2="90" y2="62" stroke="#2a2a2a" stroke-width="0.7"/>';
  // Half court line
  h += '<line x1="50" y1="62" x2="50" y2="125" stroke="#2a2a2a" stroke-width="0.7"/>';
  // Service boxes
  const sbFill = state.positions===8 ? 'rgba(70,70,100,0.08)' : 'none';
  const sbStroke = state.positions===8 ? '#333' : '#222';
  h += `<rect x="10" y="62" width="16" height="16" fill="${sbFill}" stroke="${sbStroke}" stroke-width="0.6"/>`;
  h += `<rect x="74" y="62" width="16" height="16" fill="${sbFill}" stroke="${sbStroke}" stroke-width="0.6"/>`;

  // Markers
  for (const [num, p] of Object.entries(pos)) {
    const isActive = state.current === parseInt(num);
    if (isActive) {
      h += `<circle cx="${p.x}" cy="${p.y}" r="8" fill="rgba(255,68,0,0.15)"><animate attributeName="r" values="6;12;6" dur="1.5s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.3;0.1;0.3" dur="1.5s" repeatCount="indefinite"/></circle>`;
    }
    h += `<circle cx="${p.x}" cy="${p.y}" r="${isActive?5:3.5}" fill="${isActive?'#FF4400':'#2a2a2a'}" stroke="${isActive?'#FF6B35':'#333'}" stroke-width="${isActive?0.8:0.5}"/>`;
    h += `<text x="${p.x}" y="${p.y+1.2}" text-anchor="middle" font-size="${isActive?5:4}" font-weight="700" fill="${isActive?'#fff':'#555'}" font-family="'Oswald',sans-serif">${num}</text>`;
  }
  // Labels
  h += '<text x="50" y="2.5" text-anchor="middle" font-size="3" fill="#444" font-family="\'Oswald\',sans-serif" letter-spacing="2">FRONT WALL</text>';
  h += '<text x="50" y="60" text-anchor="middle" font-size="2.5" fill="#333" font-family="\'Oswald\',sans-serif" letter-spacing="1">SHORT LINE</text>';
  h += '<text x="50" y="84" text-anchor="middle" font-size="3.5" fill="#282828" font-family="\'Bebas Neue\',sans-serif" letter-spacing="1">T</text>';
  svg.innerHTML = h;
}

function render() {
  const pos = getPositions();
  const activePos = state.current ? pos[state.current] : null;

  // Settings visibility
  const notActive = !state.running && !state.done;
  document.getElementById('btnToggleSettings').classList.toggle('hidden', !notActive);
  document.getElementById('settingsPanel').classList.toggle('hidden', !state.showSettings || !notActive);
  document.getElementById('settingsLabel').textContent = state.showSettings ? 'Hide Settings' : 'Settings';

  // Settings values
  document.getElementById('intervalVal').textContent = state.interval;
  document.getElementById('intervalSlider').value = state.interval;
  document.getElementById('totalVal').textContent = fmt(state.totalTime);
  document.getElementById('totalSlider').value = state.totalTime;

  // Position toggle
  document.getElementById('pos6btn').className = state.positions===6?'active':'inactive';
  document.getElementById('pos8btn').className = state.positions===8?'active':'inactive';

  // Presets
  const presets = [[10,120],[15,300],[8,600],[12,900]];
  document.querySelectorAll('.presets button').forEach((b,i) => {
    b.className = (state.interval===presets[i][0]&&state.totalTime===presets[i][1]) ? 'active' : 'inactive';
  });

  // Session done
  document.getElementById('sessionDone').classList.toggle('hidden', !state.done);
  if (state.done) {
    document.getElementById('doneStats').textContent = `${state.history.length} positions · ${fmt(state.totalTime)}`;
    document.getElementById('doneDetail').textContent = `${state.positions} positions · ${state.interval}s interval`;
  }

  // Number display
  const nd = document.getElementById('numberDisplay');
  const bn = document.getElementById('bigNumber');
  const pl = document.getElementById('posLabel');
  nd.classList.toggle('hidden', state.done);
  nd.classList.toggle('running', state.running);
  bn.className = 'big-number ' + (state.current ? 'active' : 'inactive') + (state.flash ? ' flash' : '');
  bn.textContent = state.current || '—';
  pl.classList.toggle('hidden', !activePos);
  if (activePos) pl.textContent = activePos.label;

  // Flash overlay
  document.getElementById('flashOverlay').classList.toggle('active', state.flash);

  // Timers
  const ts = document.getElementById('timersSection');
  ts.classList.toggle('hidden', !state.running);
  if (state.running) {
    const st = document.getElementById('sessionTime');
    st.textContent = fmt(state.totalRemaining);
    st.style.color = state.totalRemaining<=30 ? '#FF4400' : '#888';
    const sp = state.totalTime>0 ? ((state.totalTime-state.totalRemaining)/state.totalTime)*100 : 0;
    const sb = document.getElementById('sessionBar');
    sb.style.width = sp+'%';
    sb.style.background = state.totalRemaining<=30 ? 'linear-gradient(90deg,#FF4400,#FF6B35)' : 'linear-gradient(90deg,#FF4400,#CC3600)';

    const nt = document.getElementById('nextTime');
    nt.textContent = state.countdown+'s';
    nt.style.color = state.countdown<=3 ? '#FF4400' : '#777';
    const np = state.interval>0 ? ((state.interval-state.countdown)/state.interval)*100 : 0;
    const nb = document.getElementById('nextBar');
    nb.style.width = np+'%';
    nb.style.background = state.countdown<=3 ? 'linear-gradient(90deg,#FF4400,#FF6B35)' : 'linear-gradient(90deg,#333,#555)';
  }

  // Court
  document.getElementById('courtBox').classList.toggle('hidden', state.done);
  document.getElementById('courtLabel').textContent = `Court Map · ${state.positions} Positions`;
  drawCourt();

  // Summary + button
  const sr = document.getElementById('summaryRow');
  const bm = document.getElementById('btnMain');
  sr.classList.toggle('hidden', state.running || state.done);
  bm.classList.toggle('hidden', state.done);
  document.getElementById('sumInterval').textContent = state.interval+'s';
  document.getElementById('sumTotal').textContent = fmt(state.totalTime);
  document.getElementById('sumPos').textContent = state.positions;
  bm.textContent = state.running ? 'STOP' : 'START GHOSTING';
  bm.className = 'btn-main ' + (state.running ? 'stop' : 'start');

  // History
  const hs = document.getElementById('historySection');
  hs.classList.toggle('hidden', state.history.length===0);
  document.getElementById('historyLabel').textContent = `History (${state.history.length} moves)`;
  const hg = document.getElementById('historyGrid');
  hg.innerHTML = state.history.map((n,i) => {
    const bg = i===0 ? 'rgba(255,68,0,0.15)' : '#141414';
    const bd = i===0 ? 'rgba(255,68,0,0.3)' : '#1a1a1a';
    const c = i===0 ? '#FF4400' : '#444';
    return `<div class="history-item" style="background:${bg};border:1px solid ${bd};color:${c};opacity:${1-i*0.03}">${n}</div>`;
  }).join('');

  // Position key
  const pk = document.getElementById('positionKey');
  pk.innerHTML = Object.entries(pos).map(([n,p]) =>
    `<div class="pk-item"><span class="pk-num">${n}</span><span style="letter-spacing:1px">${p.label}</span></div>`
  ).join('');
}

// Register service worker for offline/PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// Keep screen awake during sessions
let wakeLock = null;
async function requestWakeLock() {
  try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
}
async function releaseWakeLock() {
  try { if (wakeLock) { await wakeLock.release(); wakeLock = null; } } catch(e) {}
}

// Patch start/stop to manage wake lock
const _startSession = startSession;
startSession = function() { requestWakeLock(); _startSession(); };
const _stopSession = stopSession;
stopSession = function(f) { releaseWakeLock(); _stopSession(f); };

// Init
loadSettings();
render();
</script>

</body>
</html>
